<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web Traffic exchange</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
    window.addEventListener("load", initialize);
    function initialize(){
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        document.getElementById("username").innerHTML=urlParams.get("username");
        // main.js

        // POST request using fetch()
        fetch("https://os6p24onhg.execute-api.eu-north-1.amazonaws.com/live/search_sites", {

            // Adding method type
            method: "POST",

            // Adding body or contents to send
            body: JSON.stringify(
                {
                user_name: urlParams.get("username"),
                session_id: urlParams.get("session")
                }
            ),

            // Adding headers to the request
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
        })

        // Converting to JSON
        .then(response => response.json())
        // Displaying results to console
        .then(data => {
            if (data['statusCode']==200) {
                console.log(data);
                document.getElementById("sites").innerHTML="";
                constructTable(JSON.parse(data['body']['sites']), document.getElementById("sites"))
                document.getElementById("current_balance").innerHTML=JSON.parse(data['body']['credit']);
            }

        })
        .catch(error =>console.log(error))

    }
    setInterval(initialize, 600000);

    function constructTable(list, selector) {

    // Getting the all column names
        let cols = Headers(list, selector);

    // Traversing the JSON data
        for (let i = 0; i < list.length; i++) {
            let row = $('<tr/>');
            for (let colIndex = 0; colIndex < cols.length; colIndex++) {
                let val = list[i][cols[colIndex]];

                // If there is any key, which is matching
                // with the column name
                if (val == null) val = "";
                row.append($('<td/>').html(val));
            }
            if(list[i][cols[1]] == "INACTIVE"){
                row.addClass("row-inactive");
                row.append($('<td/>').html('<input type="button" class="button-row" value="Add" onclick="add_remove_site(\'' + list[i][cols[0]] +'\',\'ADD\')">'));
            }
            else{
                row.addClass("row-active");
                row.append($('<td/>').html('<input type="button" class="button-row" value="remove" onclick="add_remove_site(\'' + list[i][cols[0]] +'\',\'REMOVE\')">'));
            }
            // Adding each row to the table
            $(selector).append(row);
        }
        }

    function Headers(list, selector) {
        let columns = [];
        let header = $('<tr/>');

        for (let i = 0; i < list.length; i++) {
            let row = list[i];

            for (let k in row) {
                if ($.inArray(k, columns) == -1) {
                    columns.push(k);

                    // Creating the header
                    header.append($('<th/>').html(k));
                }
            }

        }
        header.append($('<th/>').html("ACTION"));

        // Appending the header to the table
        $(selector).append(header);
        return columns;
    }

    function add_site(){
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);

        // POST request using fetch()
        fetch("https://os6p24onhg.execute-api.eu-north-1.amazonaws.com/live/sites", {

            // Adding method type
            method: "POST",

            // Adding body or contents to send
            body: JSON.stringify(
                {
                user_name: urlParams.get("username"),
                session_id: urlParams.get("session"),
                site_url: document.getElementById("site_url").value,
                action: "ADD"
                }
            ),

            // Adding headers to the request
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
        })

        // Converting to JSON
        .then(response => response.json())

        // Displaying results to console
        .then(data => {
            console.log(data);
            if (data['statusCode']==200) {
                document.getElementById("sites").innerHTML="";
                document.getElementById("site_url").value="";
                constructTable(JSON.parse(data['body']), document.getElementById("sites"));
            }
            }
        )
        .catch(error =>console.log(error))

    }

    function add_remove_site(site_name,action){
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);

        // POST request using fetch()
        fetch("https://os6p24onhg.execute-api.eu-north-1.amazonaws.com/live/sites", {

            // Adding method type
            method: "POST",

            // Adding body or contents to send
            body: JSON.stringify(
                {
                user_name: urlParams.get("username"),
                session_id: urlParams.get("session"),
                site_url: site_name,
                action: action
                }
            ),

            // Adding headers to the request
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
        })

        // Converting to JSON
        .then(response => response.json())

        // Displaying results to console
        .then(data => {
            console.log(data);
            if (data['statusCode']==200) {
                document.getElementById("sites").innerHTML="";
                document.getElementById("site_url").value="";
                constructTable(JSON.parse(data['body']), document.getElementById("sites"));
            }
            }
        )
        .catch(error =>console.log(error))

    }
    function start_traffic_exchange(){
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        window.open('https://www.webtrafficexchange.co.uk/exchnage.html?username='+urlParams.get("username") + "&session=" + urlParams.get("session"),'_blank');
    }
    </script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<table width="100%" style="border-collapse:collapse; border-spacing: 30px;">
    <tr>
        <td align="center" colspan="2">
            <h1><img src="favicon.png" alt="profile"
                style="vertical-align: middle;width: 50px;height: 50px;border-radius: 50%;">
                 <span style="background: #ddd;">Web Traffic Exchange</span></h1></td>
        <td align="right">
            <span id="username" style="color:#1E90FF;font-size:18px;font-family: fantasy;"></span>
            <img  src="avatar.png" alt="profile"
                 style="vertical-align: middle;width: 50px;height: 50px;border-radius: 50%;">
        </td>
    </tr>
    <tr>
        <td >
            <input id="site_url" type="text" class="text-input" placeholder="Enter your site_url">
            <input type="button" class="button" value="Add Your Site" onclick="add_site()">
        </td>
        <td>
            <input type="button"  value="Earn Minutes" class="button" onclick="start_traffic_exchange()" style="background-image: url(piggy-bank.jpg);background-repeat: no-repeat;  background-position: 10px 10px; padding-left: 42px; vertical-align: middle; "  >

        </td>
        <td>
           <img src="coin-icon-3819.png" style=" border-radius: 50%; width: 70px ; height:70px; "><label style="font-size: 24px;" id="current_balance"> 0 </label> Credit
        </td>
    </tr>
    <tr><td colspan="3"><br><br></td></tr>
    <tr>
        <td colspan="3">
            <table align="center" id="sites" border="1" width="100%">
            </table>
        </td>
    </tr>
    <tr><td colspan="3"><br><br></td></tr>
    <tr>
        <td colspan="3" align="left">
           <h3>User Guide</h3>
            <ul>
                <li> <b>Step 1</b> Add your Site using above input box - If your site doesn't violate our Terms of Service, then it'll be accepted.</li>
                <li> <b>Step 2</b> Click Earn minutes Button - Get one vistor for every site you visit.</li>
            </ul>
            <h4>Example Site URL</h4>
            <ul>
                <li><b>Youtube video </b>-  https://www.youtube.com/embed/kB0_lTja_Qo?autoplay=1 </li>
                <li><b>Website</b> -  https://www.webtrafficexchange.co.uk </li>
            </ul>
        </td>
    </tr>
    <tr>
        <td colspan="3" align="center">Â© webtrafficexchange.co.uk All Rights Reserved.</td>
    </tr>
</table>

</body>
</html>
